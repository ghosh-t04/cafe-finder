<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Cafe Finder</title>
    <!-- Use Tailwind CSS for a sleek design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use a modern font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        .cafe-list-item {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .cafe-list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* Custom scrollbar for the cafe list */
        .cafe-list-container::-webkit-scrollbar {
            width: 8px;
        }

        .cafe-list-container::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
            border-radius: 10px;
        }

        .cafe-list-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 10px;
            border: 2px solid #f1f5f9;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        .loading-overlay {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(2px);
            z-index: 10;
        }
    </style>
</head>
<body class="bg-slate-100 flex flex-col md:flex-row h-full">

    <!-- Loading message box, hidden by default -->
    <div id="messageBox" class="hidden fixed inset-0 flex items-center justify-center p-4 loading-overlay fade-in">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center flex flex-col items-center">
            <svg class="animate-spin h-8 w-8 text-blue-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="messageText" class="text-slate-700 font-medium">Getting your location and finding nearby cafes...</p>
        </div>
    </div>

    <!-- ETA and Distance Info Box -->
    <div id="infoBox" class="hidden fixed top-4 right-4 z-20 bg-white p-4 rounded-xl shadow-lg border border-slate-200 fade-in w-72">
        <div class="flex justify-between items-center mb-2">
            <h3 class="text-lg font-bold text-slate-800" id="cafeName"></h3>
            <button id="closeInfoBoxBtn" class="text-slate-400 hover:text-slate-600 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
        <div class="space-y-2">
            <p class="text-slate-500 text-sm flex items-center">
                <svg class="h-4 w-4 mr-2 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                </svg>
                Distance: <span id="distanceText" class="font-semibold text-slate-700 ml-1">...</span>
            </p>
            <p class="text-slate-500 text-sm flex items-center">
                <svg class="h-4 w-4 mr-2 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                ETA (Walking): <span id="etaText" class="font-semibold text-slate-700 ml-1">...</span>
            </p>
        </div>
    </div>
    
    <!-- Sidebar for search and cafe list -->
    <div class="w-full md:w-1/3 lg:w-1/4 p-4 md:p-6 flex flex-col h-full overflow-hidden">
        <header class="mb-4">
            <h1 class="text-3xl font-bold text-slate-800">Cafe Finder</h1>
            <p class="text-slate-500 mt-1">Find your perfect spot to relax and refuel.</p>
        </header>

        <!-- Search input with icon -->
        <div class="relative mb-4">
            <input type="text" id="searchInput" placeholder="Search for cafes..."
                   class="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors shadow-sm text-slate-700">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </div>

        <!-- Cafe list container -->
        <div id="cafeList" class="flex-grow overflow-y-auto pr-2 cafe-list-container">
            <!-- Cafe list items will be injected here by JavaScript -->
            <p id="initialMessage" class="text-slate-500 text-center mt-10">Search for cafes or wait for your location to load.</p>
        </div>
    </div>

    <!-- Main map container -->
    <div id="map" class="flex-grow h-full rounded-xl shadow-lg overflow-hidden md:ml-4"></div>

    <!-- Google Maps API script, loaded dynamically -->
    <script>
        // Placeholder for your Google Maps API Key
        // Get your key here: https://developers.google.com/maps/documentation/javascript/get-api-key
        const API_KEY = 'AIzaSyAGPCgS4AkqXIJxSaU3mHUVqhL3FAF3iis';

        let map, placesService, distanceMatrixService, infoWindow;
        let markers = [];
        let userLocation = { lat: -34.397, lng: 150.644 }; // Default location if geolocation fails

        const searchInput = document.getElementById('searchInput');
        const cafeList = document.getElementById('cafeList');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const initialMessage = document.getElementById('initialMessage');

        // New elements for the info box
        const infoBox = document.getElementById('infoBox');
        const closeInfoBoxBtn = document.getElementById('closeInfoBoxBtn');
        const cafeName = document.getElementById('cafeName');
        const distanceText = document.getElementById('distanceText');
        const etaText = document.getElementById('etaText');

        // Show a message to the user
        function showMessage(text) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        }

        // Hide the message box
        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        // Clear all markers from the map
        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }

        // Initialize the map and services
        function initMap() {
            hideMessage();
            map = new google.maps.Map(document.getElementById('map'), {
                center: userLocation,
                zoom: 15,
                disableDefaultUI: true,
                zoomControl: true,
            });

            // Initialize Places Service
            placesService = new google.maps.places.PlacesService(map);
            // Initialize Distance Matrix Service
            distanceMatrixService = new google.maps.DistanceMatrixService();
            // Initialize InfoWindow for markers
            infoWindow = new google.maps.InfoWindow();

            // Set up a new search on map idle
            map.addListener('idle', () => {
                performSearch(searchInput.value || 'cafe');
            });
            
            // Set up Autocomplete on the search input
            const autocomplete = new google.maps.places.Autocomplete(searchInput);
            autocomplete.bindTo('bounds', map);
            
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (!place.geometry || !place.geometry.location) {
                    console.error("Autocomplete returned a place with no geometry.");
                    return;
                }
                
                // If the place has a geometry, then move the map to that location
                map.setCenter(place.geometry.location);
                map.setZoom(15);
                performSearch(place.name);
            });
            
            // Handle manual search on Enter key press
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    performSearch(e.target.value);
                }
            });

            // Add a click listener to the close button on the info box
            closeInfoBoxBtn.addEventListener('click', () => {
                infoBox.classList.add('hidden');
            });
        }

        // Perform a search for cafes
        function performSearch(query) {
            if (!query) {
                return;
            }

            showMessage(`Searching for "${query}"...`);
            clearMarkers();
            cafeList.innerHTML = '';
            infoBox.classList.add('hidden'); // Hide info box on new search
            
            // Use a Places API Text Search request
            const request = {
                location: map.getCenter(),
                radius: '5000', // Search within a 5km radius
                query: query + ' cafe',
            };

            placesService.textSearch(request, (results, status) => {
                hideMessage();
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    displayCafes(results);
                } else if (status === google.maps.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                    cafeList.innerHTML = `<p class="text-center text-slate-500 mt-10">No cafes found. Try a different search.</p>`;
                } else {
                    cafeList.innerHTML = `<p class="text-center text-red-500 mt-10">Error fetching results: ${status}</p>`;
                    console.error('Places API error:', status);
                }
            });
        }

        // Function to calculate and display distance/eta
        function calculateAndDisplayInfo(destination, name) {
            const request = {
                origins: [userLocation],
                destinations: [destination],
                travelMode: google.maps.TravelMode.WALKING,
                unitSystem: google.maps.UnitSystem.METRIC,
            };

            distanceMatrixService.getDistanceMatrix(request, (response, status) => {
                if (status === google.maps.DistanceMatrixStatus.OK) {
                    const element = response.rows[0].elements[0];
                    if (element.status === 'OK') {
                        cafeName.textContent = name;
                        distanceText.textContent = element.distance.text;
                        etaText.textContent = element.duration.text;
                        infoBox.classList.remove('hidden');
                    } else {
                        console.error('Distance Matrix error:', element.status);
                        // Optionally hide the box or show an error
                        infoBox.classList.add('hidden');
                    }
                } else {
                    console.error('Distance Matrix Service failed:', status);
                    infoBox.classList.add('hidden');
                }
            });
        }

        // Display cafes on the map and in the list
        function displayCafes(places) {
            if (initialMessage) {
                initialMessage.remove();
            }
            places.forEach((place) => {
                if (!place.geometry || !place.geometry.location) return;

                // Create a marker for each place
                const marker = new google.maps.Marker({
                    map,
                    position: place.geometry.location,
                    title: place.name,
                });
                markers.push(marker);

                // Add a click listener to the marker
                google.maps.event.addListener(marker, 'click', () => {
                    infoWindow.setContent(
                        `<div class="p-2">
                            <h3 class="font-bold text-lg">${place.name}</h3>
                            <p class="text-sm text-slate-600">${place.formatted_address}</p>
                            ${place.rating ? `<p class="text-sm mt-1">Rating: <span class="font-medium text-amber-500">${place.rating}</span> stars</p>` : ''}
                        </div>`
                    );
                    infoWindow.open(map, marker);
                    calculateAndDisplayInfo(place.geometry.location, place.name);
                });

                // Create and append the list item
                const listItem = document.createElement('div');
                listItem.className = 'bg-white p-4 mb-4 rounded-xl shadow-md flex items-start space-x-4 cafe-list-item fade-in';
                listItem.innerHTML = `
                    <div class="flex-shrink-0 w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.5-3.5a1.5 1.5 0 013 0v3.5a1.5 1.5 0 01-3 0v-3.5z" />
                        </svg>
                    </div>
                    <div class="flex-grow">
                        <h4 class="font-semibold text-slate-800">${place.name}</h4>
                        <p class="text-slate-500 text-sm mt-1">${place.formatted_address}</p>
                        ${place.rating ? `<p class="text-slate-500 text-sm mt-1">Rating: <span class="font-medium text-amber-500">${place.rating}</span></p>` : ''}
                    </div>
                `;
                listItem.addEventListener('click', () => {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                    // Open the info window for the selected marker
                    google.maps.event.trigger(marker, 'click');
                    calculateAndDisplayInfo(place.geometry.location, place.name);
                });
                cafeList.appendChild(listItem);
            });
        }

        // Load the Google Maps script
        function loadMapsScript() {
            if (typeof google === 'object' && typeof google.maps === 'object') {
                initMap();
                return;
            }

            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initMap&libraries=places,distance_matrix`;
            script.async = true;
            document.head.appendChild(script);
            script.onerror = () => {
                showMessage('Error loading Google Maps script. Check your API key.');
                console.error('Failed to load Google Maps script. Is your API key correct?');
            };
        }

        // Get user's current location and initialize the map
        function getLocationAndLoadMap() {
            if (navigator.geolocation) {
                showMessage('Getting your location...');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        loadMapsScript();
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        showMessage('Could not get your location. Using default.');
                        loadMapsScript();
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                console.error('Geolocation is not supported by this browser.');
                showMessage('Geolocation is not supported by your browser. Using default.');
                loadMapsScript();
            }
        }

        // Start the process when the window loads
        window.onload = getLocationAndLoadMap;

    </script>
</body>
</html>
